generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  passwordHash    String?
  name            String?
  image           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  memes           Meme[]
  accounts        Account[]
  sessions        Session[]
  subscription    Subscription?
  creditBalance   CreditBalance?
  referrals       Referral[] @relation("Referrals")
  referredBy      Referral? @relation("Referred")
  payments        Payment[]
  
  @@index([email])
}

model Meme {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  imageUrl    String
  topText     String   @default("")
  bottomText  String   @default("")
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([isPublic])
  @@index([isPublic, createdAt])  // Composite index –¥–ª—è –ª–µ–Ω—Ç—ã
  @@index([userId, createdAt])    // Composite index –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// üí∞ Monetization Models
// ============================================

model Subscription {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan              String   // "free" | "premium" | "pro"
  status            String   // "active" | "cancelled" | "expired" | "trialing"
  currentPeriodEnd  DateTime?
  cancelAtPeriodEnd Boolean  @default(false)
  cancelledAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([userId])
  @@index([plan])
  @@index([status])
}

model CreditBalance {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance    Int      @default(0)
  lifetime   Int      @default(0)  // –í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([userId])
}

model CreditTransaction {
  id          String   @id @default(cuid())
  userId      String
  amount      Int      // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π = –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π = —Å–ø–∏—Å–∞–Ω–∏–µ
  type        String   // "purchase" | "generation" | "referral" | "bonus" | "refund"
  description String
  balance     Int      // –ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

model Referral {
  id           String   @id @default(cuid())
  referrerId   String
  refereeId    String   @unique
  referrer     User     @relation("Referrals", fields: [referrerId], references: [id])
  referee      User     @relation("Referred", fields: [refereeId], references: [id])
  creditsEarned Int    @default(0)
  createdAt    DateTime @default(now())
  
  @@index([referrerId])
}

model Payment {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount          Int      // –í –∫–æ–ø–µ–π–∫–∞—Ö/—Ü–µ–Ω—Ç–∞—Ö
  currency        String   // "RUB" | "USD" | "EUR"
  status          String   // "pending" | "succeeded" | "failed" | "refunded"
  provider        String   // "yookassa" | "stripe" | "cloudpayments"
  providerPaymentId String?
  description     String
  metadata        String?  // JSON —Å—Ç—Ä–æ–∫–∞ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([provider])
  @@index([createdAt])
}

model PromoCode {
  id          String   @id @default(cuid())
  code        String   @unique
  type        String   // "discount" | "credits"
  value       Int      // –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä–µ–¥–∏—Ç–æ–≤
  maxUses     Int      @default(1)
  usedCount   Int      @default(0)
  expiresAt   DateTime?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  @@index([code])
  @@index([isActive])
}
